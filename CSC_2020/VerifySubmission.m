submissionFolder = 'C:\CTC2020\Submission';

versions = {...
'C:\CTC2020\Challenge', 'BF-C2DL-HSC',          'BF-C2DL-HSC_01',           '_200102_002711_CTC_2020_initial'
'C:\CTC2020\Challenge', 'BF-C2DL-HSC',          'BF-C2DL-HSC_02',           '_200102_002711_CTC_2020_initial'
'C:\CTC2020\Challenge', 'BF-C2DL-MuSC',         'BF-C2DL-MuSC_01',          '_200229_222153_2watersheds'
'C:\CTC2020\Challenge', 'BF-C2DL-MuSC',         'BF-C2DL-MuSC_02',          '_200229_222153_2watersheds'
'C:\CTC2020\Challenge', 'DIC-C2DH-HeLa',        'DIC-C2DH-HeLa_01',         '_200102_002711_CTC_2020_initial'
'C:\CTC2020\Challenge', 'DIC-C2DH-HeLa',        'DIC-C2DH-HeLa_02',         '_200102_002711_CTC_2020_initial'
'C:\CTC2020\Challenge', 'Fluo-C2DL-MSC',        'Fluo-C2DL-MSC_01',         '_200227_052035_tophat_filter'
'C:\CTC2020\Challenge', 'Fluo-C2DL-MSC',        'Fluo-C2DL-MSC_02',         '_200227_052035_tophat_filter'
'C:\CTC2020\Challenge', 'Fluo-C3DH-A549',       'Fluo-C3DH-A549_01',        '_200102_002711_CTC_2020_initial'
'C:\CTC2020\Challenge', 'Fluo-C3DH-A549',       'Fluo-C3DH-A549_02',        '_200102_002711_CTC_2020_initial'
'C:\CTC2020\Challenge', 'Fluo-C3DH-A549-SIM',   'Fluo-C3DH-A549-SIM_01',    '_200102_002711_CTC_2020_initial'
'C:\CTC2020\Challenge', 'Fluo-C3DH-A549-SIM',   'Fluo-C3DH-A549-SIM_02',    '_200102_002711_CTC_2020_initial'
'C:\CTC2020\Challenge', 'Fluo-C3DH-H157',       'Fluo-C3DH-H157_01',        '_200102_002711_CTC_2020_initial'
'C:\CTC2020\Challenge', 'Fluo-C3DH-H157',       'Fluo-C3DH-H157_02',        '_200102_002711_CTC_2020_initial'
'C:\CTC2020\Challenge', 'Fluo-C3DL-MDA231',     'Fluo-C3DL-MDA231_01',      '_200102_002711_CTC_2020_initial'
'C:\CTC2020\Challenge', 'Fluo-C3DL-MDA231',     'Fluo-C3DL-MDA231_02',      '_200102_002711_CTC_2020_initial'
'C:\CTC2020\Challenge', 'Fluo-N2DH-GOWT1',      'Fluo-N2DH-GOWT1_01',       '_200102_002711_CTC_2020_initial'
'C:\CTC2020\Challenge', 'Fluo-N2DH-GOWT1',      'Fluo-N2DH-GOWT1_02',       '_200102_002711_CTC_2020_initial'
'C:\CTC2020\Challenge', 'Fluo-N2DH-SIM+',       'Fluo-N2DH-SIM+_01',        '_200102_002711_CTC_2020_initial'
'C:\CTC2020\Challenge', 'Fluo-N2DH-SIM+',       'Fluo-N2DH-SIM+_02',        '_200102_002711_CTC_2020_initial'
'C:\CTC2020\Challenge', 'Fluo-N2DL-HeLa',       'Fluo-N2DL-HeLa_01',        '_200102_002711_CTC_2020_initial'
'C:\CTC2020\Challenge', 'Fluo-N2DL-HeLa',       'Fluo-N2DL-HeLa_02',        '_200102_002711_CTC_2020_initial'
'C:\CTC2020\Challenge', 'Fluo-N3DH-CE',         'Fluo-N3DH-CE_01',          '_200102_002711_CTC_2020_initial'
'C:\CTC2020\Challenge', 'Fluo-N3DH-CE',         'Fluo-N3DH-CE_02',          '_200303_141612_short_sequence'
'C:\CTC2020\Challenge', 'Fluo-N3DH-CHO',        'Fluo-N3DH-CHO_01',         '_200102_002711_CTC_2020_initial'
'C:\CTC2020\Challenge', 'Fluo-N3DH-CHO',        'Fluo-N3DH-CHO_02',         '_200102_002711_CTC_2020_initial'
'C:\CTC2020\Challenge', 'Fluo-N3DH-SIM+',       'Fluo-N3DH-SIM+_01',        '_200102_002711_CTC_2020_initial'
'C:\CTC2020\Challenge', 'Fluo-N3DH-SIM+',       'Fluo-N3DH-SIM+_02',        '_200102_002711_CTC_2020_initial'
'C:\CTC2020\Challenge', 'Fluo-N3DL-DRO',        'Fluo-N3DL-DRO_01',         '_200102_002711_CTC_2020_initial_sel'
'C:\CTC2020\Challenge', 'Fluo-N3DL-DRO',        'Fluo-N3DL-DRO_02',         '_200102_002711_CTC_2020_initial_sel'
'C:\CTC2020\Challenge', 'Fluo-N3DL-TRIC',       'Fluo-N3DL-TRIC_01',        '_200102_002711_CTC_2020_initial_sel'
'C:\CTC2020\Challenge', 'Fluo-N3DL-TRIC',       'Fluo-N3DL-TRIC_02',        '_200102_002711_CTC_2020_initial_sel'
'D:\CTC2020\Challenge', 'Fluo-N3DL-TRIF',       'Fluo-N3DL-TRIF_01',        '_200226_021346_optimized_seg_sel'
'D:\CTC2020\Challenge', 'Fluo-N3DL-TRIF',       'Fluo-N3DL-TRIF_02',        '_200226_021346_optimized_seg_sel'
'C:\CTC2020\Challenge', 'PhC-C2DH-U373',        'PhC-C2DH-U373_01',         '_200102_002711_CTC_2020_initial'
'C:\CTC2020\Challenge', 'PhC-C2DH-U373',        'PhC-C2DH-U373_02',         '_200102_002711_CTC_2020_initial'
'C:\CTC2020\Challenge', 'PhC-C2DL-PSC',         'PhC-C2DL-PSC_01',          '_200102_002711_CTC_2020_initial'
'C:\CTC2020\Challenge', 'PhC-C2DL-PSC',         'PhC-C2DL-PSC_02',          '_200102_002711_CTC_2020_initial'};

% versions = {...
% 'C:\CTC2020\Challenge', 'Fluo-N3DL-DRO',        'Fluo-N3DL-DRO_01',         '_200102_002711_CTC_2020_initial_raw_segmentations'
% 'C:\CTC2020\Challenge', 'Fluo-N3DL-DRO',        'Fluo-N3DL-DRO_02',         '_200102_002711_CTC_2020_initial_raw_segmentations'
% 'C:\CTC2020\Challenge', 'Fluo-N3DL-TRIC',       'Fluo-N3DL-TRIC_01',        '_200102_002711_CTC_2020_initial_raw_segmentations'
% 'C:\CTC2020\Challenge', 'Fluo-N3DL-TRIC',       'Fluo-N3DL-TRIC_02',        '_200102_002711_CTC_2020_initial_raw_segmentations'
% 'D:\CTC2020\Challenge', 'Fluo-N3DL-TRIF',       'Fluo-N3DL-TRIF_01',        '_200226_021346_optimized_seg_CSB'
% 'D:\CTC2020\Challenge', 'Fluo-N3DL-TRIF',       'Fluo-N3DL-TRIF_02',        '_200226_021346_optimized_seg_CSB'};

% Check that the settings files are the same as the checked in ones.
for i = 1:size(versions,1)
    exPath = fullfile(versions{i,1}, versions{i,2});
    seqDir = versions{i,3};
    fprintf('Checking settings for %s\n', seqDir)
    seqPath = fullfile(exPath, seqDir);
    resultSettingsFile = fullfile(exPath, 'Analysis', ['CellData' versions{i,4}], 'Settings.csv');
    imData = ImageData(seqPath);
    imData_result = ImageData(seqPath, 'SettingsFile', resultSettingsFile);
    if length(imData.keys) ~= length(imData_result.keys)
        fprintf('%s has the wrong number of settings keys\n', imData.GetSeqDir())
        continue
    end
    for k = 1:length(imData.keys)
        key = imData.keys{k};
        key_result = imData_result.keys{k};
        if key ~= key_result
            fprintf('%s has the key %s checked in and %s in result\n',...
                imData.GetSeqDir(), key, key_result)
            continue
        end
        
        value = imData.values.(key);
        value_result = imData_result.values.(key);
        if ~isequaln(value, value_result)
            fprintf('%s for key %s has value %s checked in and %s in result\n',...
                imData.GetSeqDir(), key, num2str(value), num2str(value_result))
            continue
        end
    end
end

% Check that the result files are the same.
for i = 1:size(versions,1)
    exPath = fullfile(versions{i,1}, versions{i,2});
    seqDir = versions{i,3};
    fprintf('Checking files for %s\n', seqDir)
    seqPath = fullfile(exPath, seqDir);
    imData = ImageData(seqPath);
    
    resFolder = fullfile(exPath, 'Analysis', ['CellData' versions{i,4}], 'RES', [seqDir '_RES']);
    resFolder_submission = fullfile(submissionFolder, versions{i,2}, [seqDir(end-1:end) '_RES']);
    
    txtFile = fullfile(resFolder, 'res_track.txt');
    fid = fopen(txtFile);
    text = fscanf(fid, '%c', inf);
    
    txtFile_submission = fullfile(resFolder_submission, 'res_track.txt');
    fid_submission = fopen(txtFile_submission);
    text_submission = fscanf(fid_submission, '%c', inf);
    
    if ~isequal(text, text_submission)
        fprintf('The track files are different in %s\n', seqDir);
    end
    
    tifs = GetNames(resFolder, 'tif');
    
    if length(tifs) ~= imData.sequenceLength
        fprintf('%s has %d tifs but a sequence length of %d\n',...
            seqDir, length(tifs), imData.sequenceLength)
    end
    
    for j = 1:length(tifs)
        fileInfo = dir(fullfile(resFolder, tifs{j}));
        fileInfo_submission = dir(fullfile(resFolder_submission, tifs{j}));
        if fileInfo.bytes ~= fileInfo_submission.bytes
            fprintf('%s %s has %d bytes in the analysis folder but %d bytes in the submission',...
                seqDir, tifs{j}, fileInfo.bytes, fileInfo_submission.bytes)
        end
    end
end

% Check that the tracking results are consistent.
for i = 1:size(versions,1)
    seqDir = versions{i,3};
    fprintf('Verifying consistency for %s\n', seqDir)
    
    resFolder_submission = fullfile(submissionFolder, versions{i,2}, [seqDir(end-1:end) '_RES']);
    VerifyTRAConsistency(resFolder_submission)
end